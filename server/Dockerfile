# ============================
# 1ë‹¨ê³„: ë¹Œë“œ ë‹¨ê³„ (dev deps í¬í•¨)
# ============================
FROM node:20-alpine AS builder

# í•„ìš”í•˜ë©´ tz ì„¤ì •
ENV TZ=Asia/Seoul

# ì‘ì—… ë””ë ‰í„°ë¦¬
WORKDIR /app

# íŒ¨í‚¤ì§€ ì •ë³´ë§Œ ë¨¼ì € ë³µì‚¬ â†’ ìºì‹œ í™œìš©
COPY package*.json ./

# devDependencies í¬í•¨í•´ì„œ ì„¤ì¹˜ (ts, eslint ë“±)
RUN npm ci

# ë‚˜ë¨¸ì§€ ì†ŒìŠ¤ ë³µì‚¬
COPY . .

# TypeScript ë¹Œë“œ (ìˆìœ¼ë©´)
# package.json ì•ˆì— "build": "tsc" ê°™ì€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ê³  ê°€ì •
RUN npm run build --if-present

# ============================
# 2ë‹¨ê³„: ëŸ°íƒ€ì„ ì´ë¯¸ì§€ (prod ì „ìš©)
# ============================
FROM node:20-alpine AS runner

ENV NODE_ENV=production
ENV TZ=Asia/Seoul

WORKDIR /app

# prod ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
COPY package*.json ./
RUN npm ci --omit=dev

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (dist ê¸°ì¤€)
# ğŸ‘‰ ë§Œì•½ ë¹Œë“œ ê²°ê³¼ í´ë”ê°€ distê°€ ì•„ë‹ˆë¼ë©´ ì—¬ê¸° ê²½ë¡œë§Œ ë°”ê¿”ì¤˜
COPY --from=builder /app/dist ./dist

# (í™˜ê²½ë³€ìˆ˜ëŠ” ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ -e ë¡œ ë„£ëŠ” ê±¸ ì¶”ì²œ, .envëŠ” ë³´í†µ COPY ì•ˆ í•¨)
# EXPOSEëŠ” ë¬¸ì„œìš©ì´ë¼ì„œ ì‹¤ì œ í¬íŠ¸ ë§¤í•‘ì€ -p 4000:4000 ìœ¼ë¡œ í•´ì¤˜ì•¼ í•¨
EXPOSE 8080

# ì•± ì‹œì‘
# package.json ì— "start": "node dist/index.js" í˜¹ì€ ë¹„ìŠ·í•œ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ê³  ê°€ì •
CMD ["npm", "start"]
